version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "Installing dependencies for API proxy"
      - npm cache verify
      - npm install --production

  pre_build:
    commands:
      - echo "Preparing Lambda package for api-proxy"
      - echo "Build started on `date`"
      - mkdir -p lambda-package
      - cp src/proxy/api-proxy.mjs lambda-package/api-proxy.mjs
      - cp src/proxy/package.json lambda-package/package.json

  build:
    commands:
      - echo "Creating Lambda deployment package"
      - |
        cd lambda-package && \
        npm install --production --no-audit --no-fund && \
        zip -r ../api-proxy.zip . -q && \
        cd .. && \
        echo "Package size: $(du -h api-proxy.zip | cut -f1)"

  post_build:
    commands:
      - echo "Deploying Lambda function: api-proxy-${ENV}"
      - chmod +x src/proxy/deploy-proxy.sh
      - ./src/proxy/deploy-proxy.sh
      - echo "Deployment completed successfully"